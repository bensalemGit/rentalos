{
  "info": {
    "_postman_id": "c0ec1a55-5464-4285-a512-0aa4feb9c829",
    "name": "RentalOS Public Signature Flow (auto fresh token) - v4",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Admin - Login (get JWT)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/auth/login"
        },
        "body": {
          "mode": "raw",
          "raw": "{\"email\": \"{{adminEmail}}\", \"password\": \"{{adminPassword}}\"}"
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200 or 201', function () {",
              "  pm.expect([200,201]).to.include(pm.response.code);",
              "});",
              "var bodyText = pm.response.text();",
              "var jsonResp = null;",
              "try { jsonResp = pm.response.json(); } catch (e) {",
              "  throw new Error('Expected JSON but got non-JSON (maybe Cloudflare Access). First chars: ' + bodyText.slice(0,80));",
              "}",
              "var jwt = jsonResp.access_token || jsonResp.token || jsonResp.jwt || jsonResp.accessToken;",
              "pm.expect(jwt, 'JWT missing in response').to.be.a('string').and.not.empty;",
              "pm.environment.set('admin_jwt', jwt);"
            ]
          }
        }
      ]
    },
    {
      "name": "Admin - Create tenant public sign link (get public token)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{admin_jwt}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/public-links/tenant-sign/send"
        },
        "body": {
          "mode": "raw",
          "raw": "{\"leaseId\": \"{{leaseId}}\", \"ttlHours\": \"{{ttlHours}}\"}"
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200 or 201', function () {",
              "  pm.expect([200,201]).to.include(pm.response.code);",
              "});",
              "var bodyText = pm.response.text();",
              "var jsonResp = null;",
              "try { jsonResp = pm.response.json(); } catch (e) {",
              "  throw new Error('Expected JSON but got non-JSON (maybe Cloudflare Access). First chars: ' + bodyText.slice(0,80));",
              "}",
              "pm.expect(jsonResp.ok).to.eql(true);",
              "pm.expect(jsonResp.token, 'public token missing').to.be.a('string').and.not.empty;",
              "pm.environment.set('public_token', jsonResp.token);"
            ]
          }
        }
      ]
    },
    {
      "name": "Public - Info (token check)",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/api/public/info?token={{public_token}}"
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200', function () {",
              "  pm.expect(pm.response.code).to.eql(200);",
              "});",
              "var jsonResp = pm.response.json();",
              "pm.test('ok=true', function () {",
              "  pm.expect(jsonResp.ok).to.eql(true);",
              "});"
            ]
          }
        }
      ]
    },
    {
      "name": "Public - Sign (tenant)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/public/sign?token={{public_token}}"
        },
        "body": {
          "mode": "raw",
          "raw": "{\"consent\": true, \"signerName\": \"{{signerName}}\", \"signerRole\": \"{{signerRole}}\"}"
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Status is 200 or 410 (already used)', function () {",
              "  pm.expect([200,410]).to.include(pm.response.code);",
              "});",
              "var jsonResp = pm.response.json();",
              "if (pm.response.code === 200) {",
              "  pm.test('ok=true', function () { pm.expect(jsonResp.ok).to.eql(true); });",
              "} else {",
              "  pm.test('Link already used (410)', function () { pm.expect(jsonResp.statusCode).to.eql(410); });",
              "}"
            ]
          }
        }
      ]
    }
  ]
}